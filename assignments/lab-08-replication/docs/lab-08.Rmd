---
title: "Lab 08 Replication Notebook"
author: "Christopher Prener, Ph.D."
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output: 
  github_document: default
  html_notebook: default 
---

## Introduction
This is the replication notebook for Lab-08 from the course SOC 4650/5650: Introduction to GISc. 

## Load Dependencies
The following code loads the package dependencies for our analysis:

```{r package-load}
# tidyverse packages
library(dplyr)      # data wrangling

# spatial packages
library(mapview)    # preview spatial data
library(sf)         # spatial data tools
library(tidycensus) # data wrangling
library(tigris)     # data wrangling

# other packages
library(here)       # file path tools
```

## Part 1
### Question 1
First, we'll download and preview the variables using the `load_variables()` function from `tidycensus`.

```{r preview-vars}
acs <- load_variables(2018, "acs5", cache = TRUE)
```

The variable represents "PUBLIC ASSISTANCE INCOME OR FOOD STAMPS/SNAP IN THE PAST 12 MONTHS FOR HOUSEHOLDS".

### Question 2
First, we'll download the relevant ACS data using `get_acs()`. We get the data for all counties by specifying `"county"` as the geography:

```{r download-snap-counties}
snapCounties <- get_acs(geography = "county", year = 2018, state = 29, variable = "B19058_002", survey = "acs5")
```

### Question 3
Now we'll download geometric data to go along with our tabular data. We'll start by downloading the county boundary data and converting it to an sf object. The video shows you how to do this process in two steps:

```r
counties <- counties(state = 29, cb = FALSE)
counties <- st_as_sf(counties)
```

However, there is now an option within `tigris` to do it in a single call:

```{r download-counties}
counties <- counties(state = 29, cb = FALSE, class = "sf")
```

This makes it just a bit quicker to get mappable results. We can preview our shapefile with `mapview`:

```{r preview-counties}
mapview(counties)
```

### Question 4
Next, we'll clean and merge our data. First, we'll clean our county geometry data, retaining only the `GEOID` column:

```{r clean-counties}
counties <- select(counties, GEOID)
```

Then we'll tidy up the demographic data:

```{r clean-snap}
snapCounties %>%
  rename(
    snap = estimate,
    snap_moe = moe
  ) %>%
  select(-variable) -> snapCounties
```

Finally, we'll combine our data:

```{r join-counties}
snapCounties <- left_join(counties, snapCounties, by = "GEOID")
```

Again, we'll preview our data with `mapview`:

```{r preview-joined-counties}
mapview(snapCounties, zcol = "snap")
```

The `zcol` argument allows us to map the values of a particular variable as part of our preview.

Finally, we'll write these data as a `.shp` file:

```{r write-counties}
st_write(snapCounties, dsn = here("data", "MO_SNAP_Households", "MO_SNAP_Households.shp"), delete_dsn = TRUE)
```

## Part 2
### Question 5
First, we'll download the relevant ACS data using `get_acs()`. We get the data for all tracts by specifying `"tract"` as the geography and specifying `189` for the `county` argument:

```{r download-snap-tracts}
snapTracts <- get_acs(geography = "tract", year = 2018, state = 29, county = 189, variable = "B19058_002", survey = "acs5")
```

### Question 6
Now we'll download geometric data to go along with our tabular data:

```{r download-tracts}
tracts <- tracts(state = 29, county = 189, cb = FALSE, class = "sf")
```

We can preview our shapefile with `mapview`:

```{r preview-tracts}
mapview(tracts)
```

### Question 7
Next, we'll clean and merge our data. First, we'll clean our county geometry data, retaining only the `GEOID` column:

```{r clean-tracts}
tracts <- select(tracts, GEOID)
```

Then we'll tidy up the demographic data:

```{r clean-snap-tracts}
snapTracts %>%
  rename(
    snap = estimate,
    snap_moe = moe
  ) %>%
  select(-variable) -> snapTracts
```

Finally, we'll combine our data:

```{r join-tracts}
snapTracts <- left_join(tracts, snapTracts, by = "GEOID")
```

Again, we'll preview our data with `mapview`:

```{r preview-joined-tracts}
mapview(snapTracts, zcol = "snap")
```

Finally, we'll write these data as a `.shp` file:

```{r write-tracts}
st_write(snapTracts, dsn = here("data", "STL_SNAP_Households", "STL_SNAP_Households.shp"), delete_dsn = TRUE)
```
